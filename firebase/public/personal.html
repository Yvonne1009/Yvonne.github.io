<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/personal.css" />
    <link rel="icon" href="image/logo.ico" type="image/x-icon" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <title>LeisurePace_個人資料</title>
  </head>

  <body>
    <main class="main-content">
      <h2>我的檔案</h2>
      <form id="profileForm">
        <div class="form-group">
          <label for="username">使用者帳號</label>
          <input type="text" id="username" readonly />
        </div>
        <div class="form-group">
          <label for="name">姓名</label>
          <input type="text" id="name" required maxlength="50" />
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" required />
        </div>
        <div class="form-group">
          <label for="phone">手機號碼</label>
          <input type="text" id="phone" required maxlength="15" />
        </div>
        <div class="form-group">
          <label>性別</label>
          <input type="radio" id="male" name="gender" value="男" />
          <label for="male">男性</label>
          <input type="radio" id="female" name="gender" value="女" />
          <label for="female">女性</label>
          <input type="radio" id="other" name="gender" value="其他" />
          <label for="other">其他</label>
        </div>
        <div class="form-group">
          <label for="birthDate">生日</label>
          <input type="date" id="birthDate" name="birthDate" required />
        </div>
        <div class="form-group">
          <label for="weight">體重 (公斤)</label>
          <input
            type="number"
            id="weight"
            name="weight"
            min="0"
            max="500"
            required
          />
        </div>
        <div class="form-group">
          <label for="height">身高 (公分)</label>
          <input
            type="number"
            id="height"
            name="height"
            min="0"
            max="300"
            required
          />
        </div>
        <div class="form-group">
          <label for="exerciseFrequency">運動頻率</label>
          <select id="exerciseFrequency" name="exerciseFrequency" required>
            <option value="每天運動">每天運動</option>
            <option value="每周幾次">每周幾次</option>
            <option value="每周0 - 1次">每周0 - 1次</option>
          </select>
        </div>
        <button type="submit">儲存</button>
      </form>
    </main>
    <!-- Footer -->
    <footer id="footer" class="footer-area">
      <div class="footer-widget pt-80">
        <div class="container">
          <div class="row">
            <div class="col-lg-3 col-md-4 col-sm-8">
              <div class="footer-logo mt-50">
                <a href="#">
                  <img src="image/logo.png" alt="LeisurePace Logo" />
                </a>
                <ul class="footer-social mt-20">
                  <li>
                    <a href="#"><i class="lni-facebook-filled"></i></a>
                  </li>
                  <li>
                    <a href="#"><i class="lni-twitter-original"></i></a>
                  </li>
                  <li>
                    <a href="#"><i class="lni-google"></i></a>
                  </li>
                  <li>
                    <a href="#"><i class="lni-instagram"></i></a>
                  </li>
                </ul>
              </div>
            </div>
            <div class="col-lg-3 col-md-4 col-sm-6">
              <div class="footer-link mt-45">
                <h4 class="title">關於LeisurePace</h4>
                <ul class="mt-15">
                  <li><a href="about.html">LeisurePace</a></li>
                  <li><a href="about.html">超慢跑介紹</a></li>
                </ul>
              </div>
            </div>
            <div class="col-lg-3 col-md-4 col-sm-6">
              <div class="footer-link mt-45">
                <ul class="mt-15">
                  <li><a href="./run/run180.html">超慢跑</a></li>
                  <li><a href="analyze.html">分析</a></li>
                  <li><a href="task.html">紀錄</a></li>
                </ul>
              </div>
            </div>
            <div class="col-lg-3 col-md-4 col-sm-6">
              <div class="footer-link mt-45">
                <ul class="mt-15">
                  <li><a href="bgstore.html">背景介紹</a></li>
                  <li><a href="personal.html">個人資料</a></li>
                  <li><a href="connect.html">聯絡我們</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="copyright-area">
        <div class="container">
          <div class="row">
            <div class="col-lg-12">
              <div class="copyright text-center">
                <p>&copy; LeisurePace</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>

    <!-- Initialize Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.0.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.1/firebase-auth.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCbujMaNQH4-KIuNbSglH2SriVqvvRRa1g",
        authDomain: "leisurepace-a3d51.firebaseapp.com",
        projectId: "leisurepace-a3d51",
        storageBucket: "leisurepace-a3d51.appspot.com",
        messagingSenderId: "955257567601",
        appId: "1:955257567601:web:2e06661d84707065fe9ed0",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();

      // Load user data on page load
      window.onload = function () {
        auth.onAuthStateChanged(function (user) {
          if (user) {
            const userUID = user.uid;
            document.getElementById("username").value =
              user.displayName || user.email;

            // Load user profile
            const userRef = db.collection("users").doc(userUID);
            userRef
              .get()
              .then((doc) => {
                if (doc.exists) {
                  const userProfile = doc.data();
                  document.getElementById("name").value =
                    userProfile.name || "";
                  document.getElementById("email").value =
                    userProfile.email || "";
                  document.getElementById("phone").value =
                    userProfile.phone || "";
                  document.querySelector(
                    `input[name="gender"][value="${userProfile.gender}"]`
                  ).checked = true;
                  document.getElementById("birthDate").value =
                    userProfile.birthDate
                      ? userProfile.birthDate
                          .toDate()
                          .toISOString()
                          .substring(0, 10)
                      : "";
                  document.getElementById("weight").value =
                    userProfile.weight || "";
                  document.getElementById("height").value =
                    userProfile.height || "";
                  document.getElementById("exerciseFrequency").value =
                    userProfile.exerciseFrequency || "";
                } else {
                  console.log("No user profile found.");
                }
              })
              .catch((error) => {
                console.error("Error fetching user data:", error);
              });
          } else {
            window.location.href = "./login.html";
          }
        });
      };

      // Save form data to Firestore on submit
      document
        .getElementById("profileForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const userProfile = {
            name: document.getElementById("name").value,
            email: document.getElementById("email").value,
            phone: document.getElementById("phone").value,
            gender: document.querySelector('input[name="gender"]:checked')
              .value,
            birthDate: firebase.firestore.Timestamp.fromDate(
              new Date(document.getElementById("birthDate").value)
            ),
            weight: parseFloat(document.getElementById("weight").value),
            height: parseFloat(document.getElementById("height").value),
            exerciseFrequency:
              document.getElementById("exerciseFrequency").value,
          };

          db.collection("users")
            .doc(auth.currentUser.uid)
            .set(userProfile, { merge: true })
            .then(() => {
              alert("Profile updated successfully!");
            })
            .catch((error) => {
              console.error("Error updating profile:", error);
            });
        });
    </script>
  </body>
</html>
