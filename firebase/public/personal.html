<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/personal.css" />
    <link rel="icon" href="image/logo.ico" type="image/x-icon" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.1/firebase-auth.js"></script>
    <title>LeisurePace_個人資料</title>
  </head>

  <body>
    <!-- Header -->
    <header id="masthead" class="site-header" role="banner">
      <nav class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button
              type="button"
              class="navbar-toggle"
              data-toggle="collapse"
              data-target=".navbar-ex1-collapse"
            ></button>
            <a class="navbar-brand" href="index.html">LeisurePace</a>
          </div>
          <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav navbar-right">
              <li><a href="index.html">首頁</a></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                  >關於LeisurePace <i class="fa fa-angle-double-down"></i
                ></a>
                <ul class="dropdown-menu">
                  <li><a href="about.html">LeisurePace</a></li>
                  <li><a href="about.html">超慢跑介紹</a></li>
                </ul>
              </li>
              <li><a href="./run/run180.html">超慢跑</a></li>
              <li><a href="analyze.html">分析</a></li>
              <li><a href="task.html">任務</a></li>
              <li class="dropdown active">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                  <img
                    id="profileImage"
                    src="./image/default-avatar.png"
                    class="profile-picture"
                    style="border-radius: 50%"
                    alt="Profile Image"
                  />
                </a>
                <ul class="dropdown-menu">
                  <li><a href="bgstore.html">背景介紹</a></li>
                  <li><a href="personal.html">個人資料</a></li>
                  <li><a href="connect.html">聯絡我們</a></li>
                  <li><a href="./login/login.html">登出</a></li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <h2>我的檔案</h2>
      <p>管理你的檔案以保護你的帳戶</p>
      <form id="profileForm">
        <div class="form-group">
          <label for="username">使用者帳號</label>
          <input type="text" id="username" value="yvonne803" readonly />
        </div>
        <div class="form-group">
          <label for="name">姓名</label>
          <input type="text" id="name" value="Yvonne" required />
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" value="ch*******@gmail.com" required />
          <a href="em_chag.html" aria-label="Change email">變更</a>
        </div>
        <div class="form-group">
          <label for="phone">手機號碼</label>
          <input type="text" id="phone" value="*********80" required />
          <a href="ph_chag.html" aria-label="Change phone number">變更</a>
        </div>
        <div class="form-group">
          <label for="password">密碼</label>
          <input type="password" id="password" value="*********80" readonly />
          <a href="pwd_chag.html">變更</a>
        </div>
        <div class="form-group">
          <label>性別</label>
          <input type="radio" id="male" name="gender" value="男" />
          <label for="male">男性</label>
          <input type="radio" id="female" name="gender" value="女" checked />
          <label for="female">女性</label>
          <input type="radio" id="other" name="gender" value="其他" />
          <label for="other">其他</label>
        </div>
        <div class="form-group">
          <label for="birthDate">生日</label>
          <input type="date" id="birthDate" name="birthDate" required />
        </div>
        <button type="submit">儲存</button>
      </form>
    </main>

    <!-- Footer -->
    <footer id="footer" class="footer-area">
      <div class="footer-widget pt-80">
        <div class="container">
          <div class="row">
            <div class="col-lg-3 col-md-4 col-sm-8">
              <div class="footer-logo mt-50">
                <a href="#">
                  <img src="image/logo.png" alt="LeisurePace Logo" />
                </a>
                <ul class="footer-social mt-20">
                  <li>
                    <a href="#"><i class="lni-facebook-filled"></i></a>
                  </li>
                  <li>
                    <a href="#"><i class="lni-twitter-original"></i></a>
                  </li>
                  <li>
                    <a href="#"><i class="lni-google"></i></a>
                  </li>
                  <li>
                    <a href="#"><i class="lni-instagram"></i></a>
                  </li>
                </ul>
              </div>
            </div>
            <div class="col-lg-3 col-md-4 col-sm-6">
              <div class="footer-link mt-45">
                <h4 class="title">關於LeisurePace</h4>
                <ul class="mt-15">
                  <li><a href="about.html">LeisurePace</a></li>
                  <li><a href="about.html">超慢跑介紹</a></li>
                </ul>
              </div>
            </div>
            <div class="col-lg-3 col-md-4 col-sm-6">
              <div class="footer-link mt-45">
                <ul class="mt-15">
                  <li><a href="./run/run180.html">超慢跑</a></li>
                  <li><a href="analyze.html">分析</a></li>
                  <li><a href="task.html">任務</a></li>
                </ul>
              </div>
            </div>
            <div class="col-lg-3 col-md-4 col-sm-6">
              <div class="footer-link mt-45">
                <ul class="mt-15">
                  <li><a href="bgstore.html">背景介紹</a></li>
                  <li><a href="personal.html">個人資料</a></li>
                  <li><a href="connect.html">聯絡我們</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="copyright-area">
        <div class="container">
          <div class="row">
            <div class="col-lg-12">
              <div class="copyright text-center">
                <p>&copy; LeisurePace</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>

    <!-- -- -- -- -- -- JavaScript-- -- -- -- -- --  -->
    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCbujMaNQH4-KIuNbSglH2SriVqvvRRa1g",
        authDomain: "leisurepace-a3d51.firebaseapp.com",
        projectId: "leisurepace-a3d51",
        storageBucket: "leisurepace-a3d51.appspot.com",
        messagingSenderId: "955257567601",
        appId: "1:955257567601:web:2e06661d84707065fe9ed0",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();

      auth.onAuthStateChanged((user) => {
        if (user) {
          const userUID = user.uid;
          const username = user.email;

          // 清空表單資料避免殘留舊資料
          document.getElementById("profileForm").reset();

          // 更新使用者名稱（登入使用者的 email）
          document.getElementById("username").value = username;

          // 從 Firestore 獲取新使用者的資料
          const userRef = db.collection("users").doc(userUID);
          userRef
            .get()
            .then((doc) => {
              if (doc.exists) {
                const userProfile = doc.data();
                console.log(userProfile); // 確保這裡能看到正確的數據

                document.getElementById("name").value = userProfile.name || "";
                document.getElementById("email").value =
                  userProfile.email || "";
                document.getElementById("phone").value =
                  userProfile.phone || "";
                document.querySelector(
                  `input[name="gender"][value="${userProfile.gender}"]`
                ).checked = true;
                document.getElementById("birthDate").value =
                  userProfile.birthDate || "";
              } else {
                console.log("No user profile found.");
              }
            })
            .catch((error) => {
              console.error("Error fetching user data:", error);
              alert(
                "There was an error fetching your profile. Please try again."
              );
            });
        } else {
          // 如果未登入，導向至登入頁面
          window.location.href = "./login/login.html";
        }
      });

      // 登出功能：登出並清空表單內容
      document
        .querySelector('.dropdown-menu a[href="./login/login.html"]')
        .addEventListener("click", () => {
          auth
            .signOut()
            .then(() => {
              document.getElementById("profileForm").reset(); // 清空表單資料
              console.log("User signed out.");
            })
            .catch((error) => {
              console.error("Sign out error:", error);
            });
        });

      // 設定檔表單提交事件監聽器
      document
        .getElementById("profileForm")
        .addEventListener("submit", function (e) {
          e.preventDefault(); // Prevent page refresh

          // 取得表單輸入值
          const name = document.getElementById("name").value;
          const email = document.getElementById("email").value;
          const phone = document.getElementById("phone").value;
          const gender = document.querySelector(
            'input[name="gender"]:checked'
          ).value;
          const birthDate = document.getElementById("birthDate").value;

          // 確保所有必填欄位已填寫
          if (name && email && phone && birthDate) {
            const userProfile = {
              name,
              email,
              phone,
              gender,
              birthDate,
            };

            // 使用 UID 將使用者設定檔資料儲存到 Firestore
            db.collection("users")
              .doc(auth.currentUser.uid)
              .set(userProfile)
              .then(() => {
                alert("Profile updated successfully!");
              })
              .catch((error) => {
                console.error("Error updating profile:", error);
                alert(
                  "There was an error updating your profile. Please try again."
                );
              });
          } else {
            alert("Please fill out all required fields.");
          }
        });
    </script>
  </body>
</html>
