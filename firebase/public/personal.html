<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/personal.css" />
    <link rel="icon" href="image/logo.ico" type="image/x-icon" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.1/firebase-storage.js"></script>
    <title>LeisurePace_個人資料</title>
  </head>

  <body>
    <!-- Header -->
    <header id="masthead" class="site-header" role="banner">
      <nav class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button
              type="button"
              class="navbar-toggle"
              data-toggle="collapse"
              data-target=".navbar-ex1-collapse"
            ></button>
            <a class="navbar-brand" href="index.html">LeisurePace</a>
          </div>
          <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav navbar-right">
              <li><a href="index.html">首頁</a></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                  >關於LeisurePace <i class="fa fa-angle-double-down"></i
                ></a>
                <ul class="dropdown-menu">
                  <li><a href="about.html">LeisurePace</a></li>
                  <li><a href="about.html">超慢跑介紹</a></li>
                </ul>
              </li>
              <li><a href="./run/run180.html">超慢跑</a></li>
              <li><a href="analyze.html">分析</a></li>
              <li><a href="task.html">任務</a></li>
              <li class="dropdown active">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                  <img
                    id="profileImage"
                    src="./image/default-avatar.png"
                    class="profile-picture"
                    style="border-radius: 50%"
                    alt="Profile Image"
                  />
                </a>
                <ul class="dropdown-menu">
                  <li><a href="bgstore.html">背景介紹</a></li>
                  <li><a href="personal.html">個人資料</a></li>
                  <li><a href="connect.html">聯絡我們</a></li>
                  <li><a href="./login/login.html">登出</a></li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <h2>我的檔案</h2>
      <p>管理你的檔案以保護你的帳戶</p>
      <form id="profileForm">
        <div class="form-group">
          <label for="username">使用者帳號</label>
          <input type="text" id="username" value="yvonne803" readonly />
        </div>
        <div class="form-group">
          <label for="name">姓名</label>
          <input type="text" id="name" value="" required />
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" value="" required />
          <a href="em_chag.html" aria-label="Change email">變更</a>
        </div>
        <div class="form-group">
          <label for="phone">手機號碼</label>
          <input type="text" id="phone" value="" required />
          <a href="ph_chag.html" aria-label="Change phone number">變更</a>
        </div>
        <div class="form-group">
          <label for="password">密碼</label>
          <input type="password" id="password" value="*********80" readonly />
          <a href="pwd_chag.html">變更</a>
        </div>
        <div class="form-group">
          <label>性別</label>
          <input type="radio" id="male" name="gender" value="男" />
          <label for="male">男性</label>
          <input type="radio" id="female" name="gender" value="女" />
          <label for="female">女性</label>
          <input type="radio" id="other" name="gender" value="其他" />
          <label for="other">其他</label>
        </div>
        <div class="form-group">
          <label for="birthDate">生日</label>
          <input type="date" id="birthDate" name="birthDate" required />
        </div>
        <div>
          <label>身高：</label>
          <input type="number" id="height" name="height" required />
        </div>
        <div>
          <label>體重：</label>
          <input type="number" id="weight" name="weight" required />
        </div>
        <div>
          <label>運動頻率：</label>
          <select id="exerciseFrequency" name="exerciseFrequency">
            <option value="每天運動">每天運動</option>
            <option value="每周幾次">每周幾次</option>
            <option value="每周0 - 1次">每周0 - 1次</option>
          </select>
        </div>
        <!-- 顯示用戶頭像 -->
        <div>
          <label>頭像：</label>
          <img id="user-avatar" src="" alt="頭像" width="100" height="100" />
        </div>

        <!-- 更換頭像 -->
        <div>
          <label for="avatar-upload">更換頭像：</label>
          <input type="file" id="avatar-upload" accept="image/*" />
          <button type="button" onclick="uploadAvatar()">上傳</button>
        </div>
        <button type="submit">儲存</button>
      </form>
    </main>

    <!-- -- -- -- -- -- JavaScript-- -- -- -- -- --  -->
    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCbujMaNQH4-KIuNbSglH2SriVqvvRRa1g",
        authDomain: "leisurepace-a3d51.firebaseapp.com",
        projectId: "leisurepace-a3d51",
        storageBucket: "leisurepace-a3d51.appspot.com",
        messagingSenderId: "955257567601",
        appId: "1:955257567601:web:2e06661d84707065fe9ed0",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();

      // 監聽使用者狀態變更
      auth.onAuthStateChanged((user) => {
        if (user) {
          const userUID = user.uid;

          // 從 Firestore 獲取使用者的資料
          const userRef = db.collection("users").doc(userUID);
          userRef
            .get()
            .then((doc) => {
              if (doc.exists) {
                const userProfile = doc.data();
                console.log(userProfile); // 確保這裡能看到正確的數據

                // 填寫表單資料
                document.getElementById("name").value = userProfile.name || "";
                document.getElementById("email").value =
                  userProfile.email || "";
                document.getElementById("phone").value =
                  userProfile.phone || "";
                document.querySelector(
                  `input[name="gender"][value="${userProfile.gender}"]`
                ).checked = true;

                // 確保日期格式正確
                if (userProfile.birthDate && userProfile.birthDate.toDate) {
                  document.getElementById("birthDate").value =
                    userProfile.birthDate
                      .toDate()
                      .toISOString()
                      .substring(0, 10);
                } else {
                  document.getElementById("birthDate").value =
                    userProfile.birthDate || "";
                }

                // 填寫身高、體重、運動頻率
                document.getElementById("height").value =
                  userProfile.height || "";
                document.getElementById("weight").value =
                  userProfile.weight || "";
                document.getElementById("exerciseFrequency").value =
                  userProfile.exerciseFrequency || "每周幾次";
              } else {
                console.log("No user profile found.");
              }
            })
            .catch((error) => {
              console.error("Error fetching user data:", error);
              alert(
                "There was an error fetching your profile. Please try again."
              );
            });
        } else {
          // 如果未登入，導向至登入頁面
          window.location.href = "./login/login.html";
        }
      });

      // 提交表單並更新 Firestore 資料
      document.getElementById("profileForm").addEventListener("submit", (e) => {
        e.preventDefault();

        const name = document.getElementById("name").value;
        const email = document.getElementById("email").value;
        const phone = document.getElementById("phone").value;
        const gender = document.querySelector(
          'input[name="gender"]:checked'
        ).value;
        const birthDate = document.getElementById("birthDate").value;
        const height = document.getElementById("height").value;
        const weight = document.getElementById("weight").value;
        const exerciseFrequency =
          document.getElementById("exerciseFrequency").value;

        if (
          name &&
          email &&
          phone &&
          birthDate &&
          height &&
          weight &&
          exerciseFrequency
        ) {
          const userProfile = {
            name,
            email,
            phone,
            gender,
            birthDate,
            height,
            weight,
            exerciseFrequency,
          };

          // 更新 Firestore 中的使用者資料
          db.collection("users")
            .doc(auth.currentUser.uid)
            .update(userProfile)
            .then(() => {
              alert("Profile updated successfully!");
            })
            .catch((error) => {
              console.error("Error updating profile:", error);
              alert(
                "There was an error updating your profile. Please try again."
              );
            });
        } else {
          alert("Please fill out all required fields.");
        }
      });
    </script>
  </body>
</html>
