<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/task.css" />
    <link rel="icon" href="image/logo.ico" type="image/x-icon" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      integrity="sha384-kB+HoBWE0e8+eAxj0NwD3wGwQ52cMUlw1U5NDzYrUSrWrjvaLq63fhp5R2+OOQ4b"
      crossorigin="anonymous"
    />
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Bootstrap JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <title>LeisurePace_任務</title>
  </head>
  <body>
    <!-- menu 開始 -->
    <header id="masthead" class="site-header" role="banner">
      <nav class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button
              type="button"
              class="navbar-toggle"
              data-toggle="collapse"
              data-target=".navbar-ex1-collapse"
            ></button>
            <a class="navbar-brand" href="index.html"> LeisurePace </a>
          </div>
          <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav navbar-right">
              <li><a href="index.html">首頁</a></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                  >關於LeisurePace <i class="fa fa-angle-double-down"></i
                ></a>
                <ul class="dropdown-menu">
                  <li><a href="about.html">LeisurePace</a></li>
                  <li><a href="about.html">超慢跑介紹</a></li>

                  <li><a href="about.html">製作團隊</a></li>
                </ul>
              </li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                  >超慢跑 <i class="fa fa-angle-double-down"></i
                ></a>
                <ul class="dropdown-menu">
                  <li><a href="#">單人遊玩</a></li>
                  <li><a href="#">好友連線</a></li>
                </ul>
              </li>
              <li class="dropdown">
                <a href="analyze.html">分析</a>
              </li>
              <li class="active" class="dropdown">
                <a href="task.html">任務 </a>
              </li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                  <img
                    src="<?php echo $imagePath; ?>"
                    class="profile-picture"
                    style="border-radius: 50%"
                  />
                </a>
                <ul class="dropdown-menu">
                  <li><a href="bgstore.html">背景介紹</a></li>
                  <li><a href="test.html">設定</a></li>
                  <li><a href="#">登出</a></li>
                </ul>
              </li>
            </ul>
            <!-- /.nav -->
          </div>
          <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
      </nav>
      <!-- /.navbar -->
    </header>
    <!-- menu 結束 -->

    <div class="container pt-80 pt-130">
      <div class="calendar">
        <div class="calendar-header" id="header"></div>
        <div class="calendar-nav">
          <button onclick="prevMonth()">Prev Month</button>
          <select id="monthSelect" onchange="changeMonth()"></select>
          <select id="yearSelect" onchange="changeYear()"></select>
          <button onclick="nextMonth()">Next Month</button>
        </div>
        <div class="calendar-body" id="calendar"></div>
      </div>

      <div class="container">
        <h2 id="todoTitle">To-Do List -</h2>
        <input type="text" id="taskInput" placeholder="Add new task..." />
        <button onclick="addTask()">Add</button>

        <div id="taskList">
          <!-- Tasks will be dynamically added here -->
        </div>
      </div>

      <div class="container">
        <h1>每日體重記錄</h1>
        <form id="weightForm">
          <label for="weightInput">輸入體重 (kg): </label>
          <input type="number" id="weightInput" step="0.1" required />
          <button type="submit">記錄體重</button>
        </form>
        <h2>體重記錄</h2>
        <div id="weightRecords"></div>
      </div>

      <div class="container">
        <h1>每日喝水記錄</h1>
        <form id="waterForm">
          <label for="waterInput">输入喝水量 (ml): </label>
          <input type="number" id="waterInput" step="1" required />
          <button type="submit">記錄喝水量</button>
        </form>
        <h2>喝水記錄</h2>
        <div id="waterRecords"></div>
      </div>

      <div class="container">
        <h1>每日步數記錄</h1>
        <form id="stepForm">
          <label for="stepInput">输入步數: </label>
          <input type="number" id="stepInput" required />
          <button type="submit">記錄步數</button>
        </form>
        <h2>步數記錄</h2>
        <div id="stepRecords"></div>
      </div>
    </div>

    <!-- Import the basic jquery lib. -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Import the associated firebase lib which the order is fixed. -->
    <script
      defer
      src="https://www.gstatic.com/firebasejs/8.0.1/firebase-app.js"
    ></script>
    <script
      defer
      src="https://www.gstatic.com/firebasejs/8.0.1/firebase-auth.js"
    ></script>
    <script
      defer
      src="https://www.gstatic.com/firebasejs/8.0.1/firebase-storage.js"
    ></script>
    <script
      defer
      src="https://www.gstatic.com/firebasejs/8.0.1/firebase-database.js"
    ></script>
    <!-- Set the firebsae config and initialize it. -->
    <script defer src="init-firebase.js"></script>

    <script>
      // 獲取日曆頭部元素和月份顯示區域元素
      const header = document.getElementById("header");
      const calendarContainer = document.getElementById("calendar");
      const monthSelect = document.getElementById("monthSelect");
      const yearSelect = document.getElementById("yearSelect");

      // 獲取當前日期信息
      let currentDate = new Date();
      let currentYear = currentDate.getFullYear();
      let currentMonth = currentDate.getMonth() + 1; // 將月份索引+1
      let currentDay = currentDate.getDate();

      // 初始化月份選擇框
      for (let i = 1; i <= 12; i++) {
        // 將月份從1开始
        const option = document.createElement("option");
        option.value = i;
        option.text = new Date(0, i - 1).toLocaleString("en", {
          month: "long",
        }); // 將月份索引-1
        monthSelect.appendChild(option);
      }
      monthSelect.selectedIndex = currentMonth - 1; // 將月份索引-1

      // 初始化年份選擇框
      for (let i = currentYear - 10; i <= currentYear + 10; i++) {
        const option = document.createElement("option");
        option.value = i;
        option.text = i;
        yearSelect.appendChild(option);
      }
      yearSelect.selectedIndex = 10; // 設置選中當前年份

      // 函數：生成月份選擇器
      function generateMonthSelector() {
        monthSelect.selectedIndex = currentMonth - 1; // 將月份索引-1
      }

      // 函數：生成日曆
      function generateCalendar(year, month) {
        const daysInMonth = new Date(year, month, 0).getDate(); // 修改獲取天數的方式
        const firstDay = new Date(year, month - 1, 1).getDay(); // 將月份索引-1
        const weekdays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

        // 清空日曆容器
        calendarContainer.innerHTML = "";

        // 添加星期標題
        for (let i = 0; i < 7; i++) {
          const weekday = document.createElement("div");
          weekday.classList.add("calendar-day");
          weekday.textContent = weekdays[i];
          calendarContainer.appendChild(weekday);
        }

        // 添加空白日期
        for (let i = 0; i < firstDay; i++) {
          const emptyDay = document.createElement("div");
          emptyDay.classList.add("calendar-day");
          emptyDay.textContent = "";
          calendarContainer.appendChild(emptyDay);
        }

        // 添加日期
        for (let i = 1; i <= daysInMonth; i++) {
          const day = document.createElement("div");
          day.classList.add("calendar-day");
          day.textContent = i;
          day.setAttribute("data-day", i); // 添加日期屬性
          day.addEventListener("click", () => {
            // 點日期时更新当前日期
            currentYear = year;
            currentMonth = month;
            currentDay = i;
            updateHeader(currentYear, currentMonth, currentDay); // 更新标题
            getTasksFromFirebase(); // 重新从 Firebase 获取任务列表并显示
          });

          // 如果是今天的日期，则添加红色背景
          if (
            year === currentYear &&
            month === currentMonth &&
            i === currentDay
          ) {
            day.classList.add("today");
          }

          calendarContainer.appendChild(day);
        }
      }

      // 函数：更新标题显示选定的年份、月份和日期
      function updateHeader(year, month, day) {
        header.innerText = `${year}年${month}月${day}日`; // 不再 +1
      }

      // 函数：添加任务到 Firebase 数据库
      function addTaskToFirebase(task) {
        database
          .ref("tasks")
          .push(task)
          .then(() => {
            console.log("Task added to Firebase database successfully!");
            getTasksFromFirebase();
          })
          .catch((error) => {
            console.error("Error adding task to Firebase database: ", error);
          });
      }

      // 函数：从 Firebase 数据库获取任务列表
      function getTasksFromFirebase() {
        const tasksRef = database.ref("tasks");
        tasksRef.on(
          "value",
          (snapshot) => {
            const tasks = snapshot.val();
            if (tasks) {
              const storedTasks = Object.values(tasks);
              displayTasks(currentYear, currentMonth, currentDay, storedTasks);
            }
          },
          (errorObject) => {
            console.error("The read failed: " + errorObject.code);
          }
        );
      }

      // 函数：显示任务列表
      function displayTasks(year, month, day, tasks) {
        const taskList = document.getElementById("taskList");
        taskList.innerHTML = "";

        const selectedDateTasks = tasks.filter((task) => {
          return task.year === year && task.month === month && task.day === day;
        });

        selectedDateTasks.forEach((task) => {
          const taskElement = document.createElement("div");
          taskElement.classList.add("task");
          if (task.completed) {
            taskElement.classList.add("completed");
          }

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = task.completed;
          checkbox.addEventListener("change", () =>
            toggleTaskCompletion(task.id, tasks)
          );

          const taskText = document.createElement("span");
          taskText.textContent = task.text;

          const deleteButton = document.createElement("button");
          deleteButton.textContent = "Delete";
          deleteButton.addEventListener("click", () =>
            deleteTask(task.id, tasks)
          );

          taskElement.appendChild(checkbox);
          taskElement.appendChild(taskText);
          taskElement.appendChild(deleteButton);

          taskList.appendChild(taskElement);
        });
      }

      // 函数：标记任务完成或未完成
      function toggleTaskCompletion(taskId, tasks) {
        const updatedTasks = tasks.map((task) => {
          if (task.id === taskId) {
            return { ...task, completed: !task.completed };
          }
          return task;
        });

        localStorage.setItem("tasks", JSON.stringify(updatedTasks));
        displayTasks(currentYear, currentMonth, currentDay, updatedTasks);
      }

      // 函数：删除任务
      function deleteTask(taskId, tasks) {
        const updatedTasks = tasks.filter((task) => task.id !== taskId);
        localStorage.setItem("tasks", JSON.stringify(updatedTasks));
        displayTasks(currentYear, currentMonth, currentDay, updatedTasks);
      }

      // 初始化日历
      generateCalendar(currentYear, currentMonth);
      updateHeader(currentYear, currentMonth, currentDate.getDate());
      getTasksFromFirebase();

      // 函数：尝试加载之前存储的任务列表
      function tryLoadPreviousTasks() {
        const storedTasks = localStorage.getItem("tasks");
        if (storedTasks) {
          const parsedTasks = JSON.parse(storedTasks);
          displayTasks(currentYear, currentMonth, currentDay, parsedTasks);
        }
      }

      // 在页面加载时尝试加载之前存储的任务列表
      tryLoadPreviousTasks();

      // 绑定月份和年份选择器的事件
      monthSelect.addEventListener("change", () => {
        currentMonth = parseInt(monthSelect.value);
        generateCalendar(currentYear, currentMonth);
        getTasksFromFirebase();
      });

      yearSelect.addEventListener("change", () => {
        currentYear = parseInt(yearSelect.value);
        generateCalendar(currentYear, currentMonth);
        getTasksFromFirebase();
      });

      // 函数：显示前一个月份
      function prevMonth() {
        if (currentMonth === 0) {
          currentYear--;
          currentMonth = 11;
        } else {
          currentMonth--;
        }
        generateMonthSelector();
        generateCalendar(currentYear, currentMonth);
        getTasksFromFirebase();
      }

      // 函数：显示下一个月份
      function nextMonth() {
        if (currentMonth === 11) {
          currentYear++;
          currentMonth = 0;
        } else {
          currentMonth++;
        }
        generateMonthSelector();
        generateCalendar(currentYear, currentMonth);
        getTasksFromFirebase();
      }

      // 在添加任务时将任务添加到 Firebase 数据库
      function addTask() {
        const input = document.getElementById("taskInput");
        const taskText = input.value.trim();

        if (taskText !== "") {
          const task = {
            id: Date.now(),
            text: taskText,
            completed: false,
            year: currentYear,
            month: currentMonth,
            day: currentDay,
          };

          addTaskToFirebase(task);
          input.value = "";
        }
      }
    </script>
    <script>
      //每日體重紀錄
      // 获取 DOM 元素
      const weightForm = document.getElementById("weightForm");
      const weightInput = document.getElementById("weightInput");
      const weightRecords = document.getElementById("weightRecords");

      // 记录体重
      weightForm.addEventListener("submit", function (event) {
        event.preventDefault();

        const weightAmount = parseFloat(weightInput.value);
        if (isNaN(weightAmount)) return;

        const date = new Date();
        const year = date.getFullYear();
        const month = date.getMonth() + 1; // 月份从 0 开始，所以需要加 1
        const day = date.getDate();

        const weightEntry = {
          amount: weightAmount,
          year: year,
          month: month,
          day: day,
        };

        addWeightToFirebase(weightEntry);
        weightInput.value = "";
      });

      // 将体重记录添加到 Firebase
      function addWeightToFirebase(weightEntry) {
        database
          .ref("weight")
          .push(weightEntry)
          .then(() => {
            console.log(
              "Weight entry added to Firebase database successfully!"
            );
            getWeightFromFirebase();
          })
          .catch((error) => {
            console.error(
              "Error adding weight entry to Firebase database: ",
              error
            );
          });
      }

      // 从 Firebase 获取体重记录
      function getWeightFromFirebase() {
        database
          .ref("weight")
          .once("value")
          .then(function (snapshot) {
            const weights = snapshot.val();
            displayWeight(weights);
          })
          .catch(function (error) {
            console.error("The read failed: " + error.code);
          });
      }

      // 显示体重记录
      function displayWeight(weights) {
        weightRecords.innerHTML = "";

        if (weights) {
          const weightEntries = Object.values(weights);
          weightEntries.forEach((entry) => {
            const weightElement = document.createElement("div");
            weightElement.classList.add("weight-entry");
            weightElement.innerHTML = `
        <span class="weight-date">${entry.year}-${entry.month}-${entry.day}:</span>
        <span class="weight-value">${entry.amount} kg</span>
      `;
            weightRecords.appendChild(weightElement);
          });
        }
      }

      // 页面加载时获取体重记录
      window.addEventListener("load", function () {
        getWeightFromFirebase();
      });
    </script>
    <script>
      //喝水記錄
      // 获取 DOM 元素
      const waterForm = document.getElementById("waterForm");
      const waterInput = document.getElementById("waterInput");
      const waterRecords = document.getElementById("waterRecords");

      // 记录喝水量
      waterForm.addEventListener("submit", function (event) {
        event.preventDefault();

        const waterAmount = parseFloat(waterInput.value);
        if (isNaN(waterAmount)) return;

        const date = new Date();
        const year = date.getFullYear();
        const month = date.getMonth() + 1; // 月份从 0 开始，所以需要加 1
        const day = date.getDate();

        const waterEntry = {
          amount: waterAmount,
          year: year,
          month: month,
          day: day,
        };

        addWaterToFirebase(waterEntry);
        waterInput.value = "";
      });

      // 将喝水记录添加到 Firebase
      function addWaterToFirebase(waterEntry) {
        database
          .ref("water")
          .push(waterEntry)
          .then(() => {
            console.log("Water entry added to Firebase database successfully!");
            getWaterFromFirebase();
          })
          .catch((error) => {
            console.error(
              "Error adding water entry to Firebase database: ",
              error
            );
          });
      }

      // 从 Firebase 获取喝水记录
      function getWaterFromFirebase() {
        database
          .ref("water")
          .once("value")
          .then(function (snapshot) {
            const waters = snapshot.val();
            displayWater(waters);
          })
          .catch(function (error) {
            console.error("The read failed: " + error.code);
          });
      }

      // 显示喝水记录
      function displayWater(waters) {
        waterRecords.innerHTML = "";

        if (waters) {
          const waterEntries = Object.values(waters);
          waterEntries.forEach((entry) => {
            const waterElement = document.createElement("div");
            waterElement.classList.add("water-entry");
            waterElement.innerHTML = `
        <span class="water-date">${entry.year}-${entry.month}-${entry.day}:</span>
        <span class="water-value">${entry.amount} ml</span>
      `;
            waterRecords.appendChild(waterElement);
          });
        }
      }

      // 页面加载时获取喝水记录
      window.addEventListener("load", function () {
        getWaterFromFirebase();
      });
    </script>
    <script>
      //步數記錄
      // 获取 DOM 元素
      const stepForm = document.getElementById("stepForm");
      const stepInput = document.getElementById("stepInput");
      const stepRecords = document.getElementById("stepRecords");

      // 记录步数
      stepForm.addEventListener("submit", function (event) {
        event.preventDefault();

        const stepAmount = parseInt(stepInput.value);
        if (isNaN(stepAmount)) return;

        const date = new Date();
        const year = date.getFullYear();
        const month = date.getMonth() + 1; // 月份从 0 开始，所以需要加 1
        const day = date.getDate();

        const stepEntry = {
          amount: stepAmount,
          year: year,
          month: month,
          day: day,
        };

        addStepToFirebase(stepEntry);
        stepInput.value = "";
      });

      // 将步数记录添加到 Firebase
      function addStepToFirebase(stepEntry) {
        database
          .ref("steps")
          .push(stepEntry)
          .then(() => {
            console.log("Step entry added to Firebase database successfully!");
            getStepsFromFirebase();
          })
          .catch((error) => {
            console.error(
              "Error adding step entry to Firebase database: ",
              error
            );
          });
      }

      // 从 Firebase 获取步数记录
      function getStepsFromFirebase() {
        database
          .ref("steps")
          .once("value")
          .then(function (snapshot) {
            const steps = snapshot.val();
            displaySteps(steps);
          })
          .catch(function (error) {
            console.error("The read failed: " + error.code);
          });
      }

      // 显示步数记录
      function displaySteps(steps) {
        stepRecords.innerHTML = "";

        if (steps) {
          const stepEntries = Object.values(steps);
          stepEntries.forEach((entry) => {
            const stepElement = document.createElement("div");
            stepElement.classList.add("step-entry");
            stepElement.innerHTML = `
        <span class="step-date">${entry.year}-${entry.month}-${entry.day}:</span>
        <span class="step-value">${entry.amount} steps</span>
      `;
            stepRecords.appendChild(stepElement);
          });
        }
      }

      // 页面加载时获取步数记录
      window.addEventListener("load", function () {
        getStepsFromFirebase();
      });
    </script>
    <!-- footer 開始 -->
    <footer id="footer" class="footer-area">
      <div class="footer-widget pt-80">
        <div class="container">
          <div class="row">
            <div class="col-lg-3 col-md-4 col-sm-8">
              <div class="footer-logo mt-50">
                <a href="#">
                  <img src="image/logo.png" alt="Logo" />
                </a>

                <ul class="footer-social mt-20">
                  <li>
                    <a href="#"><i class="lni-facebook-filled"></i></a>
                  </li>
                  <li>
                    <a href="#"><i class="lni-twitter-original"></i></a>
                  </li>
                  <li>
                    <a href="#"><i class="lni-google"></i></a>
                  </li>
                  <li>
                    <a href="#"><i class="lni-instagram"></i></a>
                  </li>
                </ul>
              </div>
              <!-- footer logo -->
            </div>
            <div class="col-lg-3 col-md-4 col-sm-6">
              <div class="footer-link mt-45">
                <div class="f-title">
                  <h4 class="title">關於LeisurePace</h4>
                </div>
                <ul class="mt-15">
                  <li><a href="about.html">LeisurePace</a></li>
                  <li><a href="about.html">超慢跑介紹</a></li>
                  <li><a href="about.html">製作團隊</a></li>
                </ul>
              </div>
            </div>
            <div class="col-lg-3 col-md-4 col-sm-6">
              <div class="footer-link mt-45">
                <div class="f-title">
                  <h4 class="title">超慢跑</h4>
                </div>
                <ul class="mt-15">
                  <li><a href="#">單人遊玩</a></li>
                  <li><a href="#">好友連線</a></li>
                </ul>
              </div>
            </div>
            <div class="col-lg-3 col-md-4 col-sm-6">
              <div class="footer-link mt-45">
                <ul class="mt-15">
                  <li><a href="analyze.html">分析</a></li>
                  <li><a href="task.html">任務</a></li>
                  <li><a href="bgstore.html">背景介紹</a></li>
                  <li><a href="test.html">設定</a></li>
                </ul>
              </div>
            </div>
          </div>
          <!-- row -->
        </div>
        <!-- container -->
      </div>
      <!-- footer widget -->
      <div class="copyright-area">
        <div class="container">
          <div class="row">
            <div class="col-lg-12">
              <div class="copyright text-center">
                <p>&copy; LeisurePace</p>
              </div>
              <!-- copyright -->
            </div>
          </div>
          <!-- row -->
        </div>
        <!-- container -->
      </div>
      <!-- copyright-area -->
    </footer>
    <!-- footer 結束 -->
  </body>
</html>
